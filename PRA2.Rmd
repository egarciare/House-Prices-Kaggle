---
title: "PRA2-Tipologia i cicle de vida de les dades - HousePrices"
author: "Damián Martínez & Eusebi Garcia"
date: "09/6/2020"
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
    includes:
      in_header: 
  pdf_document:
    highlight: zenburn
    toc: yes
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(knitr.duplicate.label = "allow")
```


```{r Libraries, message=FALSE, warning=FALSE, echo=FALSE}
library(readr)
library(dplyr)
library(tidyverse)
library(class)
library(purrr)
library(cluster)
library(ggplot2)
library(arules)
library(tseries)
library(knitr)
library(caret)
library(moments)
library(reshape2)
library(ggfortify)
library(viridis)
library(discretization)
library(fpc)
library(nortest)
library(DescTools)
#if(!require(nortest)){
 #   install.packages('nortest', repos='http://cran.us.r-project.org')
 #   library(nortest)
#}
##library(devtools)
# install.packages("plotly")
library(plotly)
library(knitr)
```
![](imatge_dataset.png)


******
# Repositori Github
******
Repositori on es troba tota la documentació de la pràctica: https://github.com/egarciare/House-Prices-Kaggle

Link a la competició de Kaggle en que es basa la pràctica: https://www.kaggle.com/c/house-prices-advanced-regression-techniques/overview


******
# Descripició i Objectiu
******
Aquest dataset conté les característiques d'un conjunt de cases amb 79 variables que descriuen gairebé completament cada aspecte d'aquestes cases residencials ubicades en Ames, Iowa. Aquest data set forma part d'un challenge en Kaggle anomenat: "HousePrices: Advance Regression Techniques" on el repte és predir el preu final de cada casa. 

En el dataset Hi ha 1460 observacions amb 81 atributs, on la variable a predir és contínua (SalePrice). 

Addicionalment a la predicció dels preus es pretén donar resposta a les següents preguntes:

* Predicció dels preus de venda (SalePrice) de les cases en funció de els seves característiques (creació d'un model de regressió lineal).
* Anàlisi per barris: diferència en el preu de venda en funció del barri on es troba la casa.
* Comparació dels preus de venda entre els anys 80 i els 90: hi ha diferències significatives entre els preus de venda en aquestes dues dècades?
* Anàlisi del preu de venda al llarg del temps: com evoluciona el preu de venda de les cases en funció de les variables temporals del dataset?

******
# Exploració del dataset
******
S'assignen a variables el dataset de train i el de test
```{r echo=TRUE, message=FALSE, warning=FALSE}
#summary(cars)
train <- read_csv('HousePrices/train.csv' )
test <- read_csv("HousePrices/test.csv")
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
names(train)
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
summary(train)
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
str(train)
```


******
# Anàlisi
******

## Atributs del dataset
S'identifiquen inicialment els atributs numèrics que poden ser d'interès per l'estimació del preu de la casa. Identificació atributs numèrics:

* OverallQual: Rates the overall material and finish of the house

       10	Very Excellent
       9	Excellent
       8	Very Good
       7	Good
       6	Above Average
       5	Average
       4	Below Average
       3	Fair
       2	Poor
       1	Very Poor

* OverallCond: Rates the overall condition of the house

       10	Very Excellent
       9	Excellent
       8	Very Good
       7	Good
       6	Above Average	
       5	Average
       4	Below Average	
       3	Fair
       2	Poor
       1	Very Poor
       
* YearBuilt: Original construction date
* YearRemodAdd: Remodel date (same as construction date if no remodeling or additions)
* MasVnrArea: Masonry veneer area in square feet
* BsmtFinSF1: Type 1 finished square feet
* BsmtFinSF2: Type 2 finished square feet
* BsmtUnfSF: Unfinished square feet of basement area
* BsmtUnfSF: Unfinished square feet of basement area
* TotalBsmtSF: Total square feet of basement area
* 1stFlrSF: First Floor square feet
* 2ndFlrSF: Second floor square feet
* LowQualFinSF: Low quality finished square feet (all floors)
* GrLivArea: Above grade (ground) living area square feet
* BsmtFullBath: Basement full bathrooms
* BsmtHalfBath: Basement half bathrooms
* FullBath: Full bathrooms above grade
* HalfBath: Half baths above grade
* TotRmsAbvGrd: Total rooms above grade (does not include bathrooms)
* Bedroom: Bedrooms above grade (does NOT include basement bedrooms)
* Kitchen: Kitchens above grade
* Fireplaces: Number of fireplaces
* GarageYrBlt: Year garage was built
* GarageCars: Size of garage in car capacity
* GarageArea: Size of garage in square feet
* WoodDeckSF: Wood deck area in square feet
* OpenPorchSF: Open porch area in square feet
* EnclosedPorch: Enclosed porch area in square feet
* 3SsnPorch: Three season porch area in square feet
* ScreenPorch: Screen porch area in square feet
* PoolArea: Pool area in square feet
* MiscVal: $Value of miscellaneous feature
* MoSold: Month Sold (MM)
* YrSold: Year Sold (YYYY)


A continuació, llistem també els atributs categòrics que poden influir en el preu:

* MSSubClass: Identifies the type of dwelling involved in the sale.	

        20	1-STORY 1946 & NEWER ALL STYLES
        30	1-STORY 1945 & OLDER
        40	1-STORY W/FINISHED ATTIC ALL AGES
        45	1-1/2 STORY - UNFINISHED ALL AGES
        50	1-1/2 STORY FINISHED ALL AGES
        60	2-STORY 1946 & NEWER
        70	2-STORY 1945 & OLDER
        75	2-1/2 STORY ALL AGES
        80	SPLIT OR MULTI-LEVEL
        85	SPLIT FOYER
        90	DUPLEX - ALL STYLES AND AGES
       120	1-STORY PUD (Planned Unit Development) - 1946 & NEWER
       150	1-1/2 STORY PUD - ALL AGES
       160	2-STORY PUD - 1946 & NEWER
       180	PUD - MULTILEVEL - INCL SPLIT LEV/FOYER
       190	2 FAMILY CONVERSION - ALL STYLES AND AGES

* MSZoning: Identifies the general zoning classification of the sale.
		
       A	Agriculture
       C	Commercial
       FV	Floating Village Residential
       I	Industrial
       RH	Residential High Density
       RL	Residential Low Density
       RP	Residential Low Density Park 
       RM	Residential Medium Density


* Street: Type of road access to property

       Grvl	Gravel	
       Pave	Paved
       	
* Alley: Type of alley access to property

       Grvl	Gravel
       Pave	Paved
       NA 	No alley access
		
* LotShape: General shape of property

       Reg	Regular	
       IR1	Slightly irregular
       IR2	Moderately Irregular
       IR3	Irregular
       
* LandContour: Flatness of the property

       Lvl	Near Flat/Level	
       Bnk	Banked - Quick and significant rise from street grade to building
       HLS	Hillside - Significant slope from side to side
       Low	Depression
		
* Utilities: Type of utilities available
		
       AllPub	All public Utilities (E,G,W,& S)	
       NoSewr	Electricity, Gas, and Water (Septic Tank)
       NoSeWa	Electricity and Gas Only
       ELO	Electricity only	
	
* LotConfig: Lot configuration

       Inside	Inside lot
       Corner	Corner lot
       CulDSac	Cul-de-sac
       FR2	Frontage on 2 sides of property
       FR3	Frontage on 3 sides of property
	
* LandSlope: Slope of property
		
       Gtl	Gentle slope
       Mod	Moderate Slope	
       Sev	Severe Slope
	
* Neighborhood: Physical locations within Ames city limits

       Blmngtn	Bloomington Heights
       Blueste	Bluestem
       BrDale	Briardale
       BrkSide	Brookside
       ClearCr	Clear Creek
       CollgCr	College Creek
       Crawfor	Crawford
       Edwards	Edwards
       Gilbert	Gilbert
       IDOTRR	Iowa DOT and Rail Road
       MeadowV	Meadow Village
       Mitchel	Mitchell
       Names	North Ames
       NoRidge	Northridge
       NPkVill	Northpark Villa
       NridgHt	Northridge Heights
       NWAmes	Northwest Ames
       OldTown	Old Town
       SWISU	South & West of Iowa State University
       Sawyer	Sawyer
       SawyerW	Sawyer West
       Somerst	Somerset
       StoneBr	Stone Brook
       Timber	Timberland
       Veenker	Veenker
			
* Condition1: Proximity to various conditions
	
       Artery	Adjacent to arterial street
       Feedr	Adjacent to feeder street	
       Norm	Normal	
       RRNn	Within 200' of North-South Railroad
       RRAn	Adjacent to North-South Railroad
       PosN	Near positive off-site feature--park, greenbelt, etc.
       PosA	Adjacent to postive off-site feature
       RRNe	Within 200' of East-West Railroad
       RRAe	Adjacent to East-West Railroad
	
* Condition2: Proximity to various conditions (if more than one is present)
		
       Artery	Adjacent to arterial street
       Feedr	Adjacent to feeder street	
       Norm	Normal	
       RRNn	Within 200' of North-South Railroad
       RRAn	Adjacent to North-South Railroad
       PosN	Near positive off-site feature--park, greenbelt, etc.
       PosA	Adjacent to postive off-site feature
       RRNe	Within 200' of East-West Railroad
       RRAe	Adjacent to East-West Railroad
	
* BldgType: Type of dwelling
		
       1Fam	Single-family Detached	
       2FmCon	Two-family Conversion; originally built as one-family dwelling
       Duplx	Duplex
       TwnhsE	Townhouse End Unit
       TwnhsI	Townhouse Inside Unit
	
* HouseStyle: Style of dwelling
	
       1Story	One story
       1.5Fin	One and one-half story: 2nd level finished
       1.5Unf	One and one-half story: 2nd level unfinished
       2Story	Two story
       2.5Fin	Two and one-half story: 2nd level finished
       2.5Unf	Two and one-half story: 2nd level unfinished
       SFoyer	Split Foyer
       SLvl	Split Level

* RoofStyle: Type of roof

       Flat	Flat
       Gable	Gable
       Gambrel	Gabrel (Barn)
       Hip	Hip
       Mansard	Mansard
       Shed	Shed
		
* RoofMatl: Roof material

       ClyTile	Clay or Tile
       CompShg	Standard (Composite) Shingle
       Membran	Membrane
       Metal	Metal
       Roll	Roll
       Tar&Grv	Gravel & Tar
       WdShake	Wood Shakes
       WdShngl	Wood Shingles
		
* Exterior1st: Exterior covering on house

       AsbShng	Asbestos Shingles
       AsphShn	Asphalt Shingles
       BrkComm	Brick Common
       BrkFace	Brick Face
       CBlock	Cinder Block
       CemntBd	Cement Board
       HdBoard	Hard Board
       ImStucc	Imitation Stucco
       MetalSd	Metal Siding
       Other	Other
       Plywood	Plywood
       PreCast	PreCast	
       Stone	Stone
       Stucco	Stucco
       VinylSd	Vinyl Siding
       Wd Sdng	Wood Siding
       WdShing	Wood Shingles
	
* Exterior2nd: Exterior covering on house (if more than one material)

       AsbShng	Asbestos Shingles
       AsphShn	Asphalt Shingles
       BrkComm	Brick Common
       BrkFace	Brick Face
       CBlock	Cinder Block
       CemntBd	Cement Board
       HdBoard	Hard Board
       ImStucc	Imitation Stucco
       MetalSd	Metal Siding
       Other	Other
       Plywood	Plywood
       PreCast	PreCast
       Stone	Stone
       Stucco	Stucco
       VinylSd	Vinyl Siding
       Wd Sdng	Wood Siding
       WdShing	Wood Shingles
	
* MasVnrType: Masonry veneer type

       BrkCmn	Brick Common
       BrkFace	Brick Face
       CBlock	Cinder Block
       None	None
       Stone	Stone

* ExterQual: Evaluates the quality of the material on the exterior 
		
       Ex	Excellent
       Gd	Good
       TA	Average/Typical
       Fa	Fair
       Po	Poor
		
* ExterCond: Evaluates the present condition of the material on the exterior
		
       Ex	Excellent
       Gd	Good
       TA	Average/Typical
       Fa	Fair
       Po	Poor
		
* Foundation: Type of foundation
		
       BrkTil	Brick & Tile
       CBlock	Cinder Block
       PConc	Poured Contrete	
       Slab	Slab
       Stone	Stone
       Wood	Wood
		
* BsmtQual: Evaluates the height of the basement

       Ex	Excellent (100+ inches)	
       Gd	Good (90-99 inches)
       TA	Typical (80-89 inches)
       Fa	Fair (70-79 inches)
       Po	Poor (<70 inches
       NA	No Basement
		
* BsmtCond: Evaluates the general condition of the basement

       Ex	Excellent
       Gd	Good
       TA	Typical - slight dampness allowed
       Fa	Fair - dampness or some cracking or settling
       Po	Poor - Severe cracking, settling, or wetness
       NA	No Basement
	
* BsmtExposure: Refers to walkout or garden level walls

       Gd	Good Exposure
       Av	Average Exposure (split levels or foyers typically score average or above)	
       Mn	Mimimum Exposure
       No	No Exposure
       NA	No Basement
	
* BsmtFinType1: Rating of basement finished area

       GLQ	Good Living Quarters
       ALQ	Average Living Quarters
       BLQ	Below Average Living Quarters	
       Rec	Average Rec Room
       LwQ	Low Quality
       Unf	Unfinshed
       NA	No Basement

* BsmtFinType2: Rating of basement finished area (if multiple types)

       GLQ	Good Living Quarters
       ALQ	Average Living Quarters
       BLQ	Below Average Living Quarters	
       Rec	Average Rec Room
       LwQ	Low Quality
       Unf	Unfinshed
       NA	No Basement

* Heating: Type of heating
		
       Floor	Floor Furnace
       GasA	Gas forced warm air furnace
       GasW	Gas hot water or steam heat
       Grav	Gravity furnace	
       OthW	Hot water or steam heat other than gas
       Wall	Wall furnace
		
* HeatingQC: Heating quality and condition

       Ex	Excellent
       Gd	Good
       TA	Average/Typical
       Fa	Fair
       Po	Poor
		
* CentralAir: Central air conditioning

       N	No
       Y	Yes
		
* Electrical: Electrical system

       SBrkr	Standard Circuit Breakers & Romex
       FuseA	Fuse Box over 60 AMP and all Romex wiring (Average)	
       FuseF	60 AMP Fuse Box and mostly Romex wiring (Fair)
       FuseP	60 AMP Fuse Box and mostly knob & tube wiring (poor)
       Mix	Mixed
		
* KitchenQual: Kitchen quality

       Ex	Excellent
       Gd	Good
       TA	Typical/Average
       Fa	Fair
       Po	Poor
       	

* Functional: Home functionality (Assume typical unless deductions are warranted)

       Typ	Typical Functionality
       Min1	Minor Deductions 1
       Min2	Minor Deductions 2
       Mod	Moderate Deductions
       Maj1	Major Deductions 1
       Maj2	Major Deductions 2
       Sev	Severely Damaged
       Sal	Salvage only
		
* FireplaceQu: Fireplace quality

       Ex	Excellent - Exceptional Masonry Fireplace
       Gd	Good - Masonry Fireplace in main level
       TA	Average - Prefabricated Fireplace in main living area or Masonry Fireplace in basement
       Fa	Fair - Prefabricated Fireplace in basement
       Po	Poor - Ben Franklin Stove
       NA	No Fireplace
		
* GarageType: Garage location
		
       2Types	More than one type of garage
       Attchd	Attached to home
       Basment	Basement Garage
       BuiltIn	Built-In (Garage part of house - typically has room above garage)
       CarPort	Car Port
       Detchd	Detached from home
       NA	No Garage
		
* GarageFinish: Interior finish of the garage

       Fin	Finished
       RFn	Rough Finished	
       Unf	Unfinished
       NA	No Garage
		
* GarageQual: Garage quality

       Ex	Excellent
       Gd	Good
       TA	Typical/Average
       Fa	Fair
       Po	Poor
       NA	No Garage
		
* GarageCond: Garage condition

       Ex	Excellent
       Gd	Good
       TA	Typical/Average
       Fa	Fair
       Po	Poor
       NA	No Garage
		
* PavedDrive: Paved driveway

       Y	Paved 
       P	Partial Pavement
       N	Dirt/Gravel

* PoolQC: Pool quality
		
       Ex	Excellent
       Gd	Good
       TA	Average/Typical
       Fa	Fair
       NA	No Pool
		
* Fence: Fence quality
		
       GdPrv	Good Privacy
       MnPrv	Minimum Privacy
       GdWo	Good Wood
       MnWw	Minimum Wood/Wire
       NA	No Fence
	
* MiscFeature: Miscellaneous feature not covered in other categories
		
       Elev	Elevator
       Gar2	2nd Garage (if not described in garage section)
       Othr	Other
       Shed	Shed (over 100 SF)
       TenC	Tennis Court
       NA	None

* SaleType: Type of sale
		
       WD 	Warranty Deed - Conventional
       CWD	Warranty Deed - Cash
       VWD	Warranty Deed - VA Loan
       New	Home just constructed and sold
       COD	Court Officer Deed/Estate
       Con	Contract 15% Down payment regular terms
       ConLw	Contract Low Down payment and low interest
       ConLI	Contract Low Interest
       ConLD	Contract Low Down
       Oth	Other
		
* SaleCondition: Condition of sale

       Normal	Normal Sale
       Abnorml	Abnormal Sale -  trade, foreclosure, short sale
       AdjLand	Adjoining Land Purchase
       Alloca	Allocation - two linked properties with separate deeds, typically condo with a garage unit	
       Family	Sale between family members
       Partial	Home was not completed when last assessed (associated with New Homes)


## Valors NA
Anàlisi dels valors NA en el total d'atributs del dataset de training:

```{r echo=TRUE, message=FALSE, warning=FALSE}
sapply(train, function(x) sum(is.na(x)))
```

Dels atributs numèrics seleccionats, s'observa que no hi ha valors NA, tot i que poden haver-hi 0, per exemple en els anys. En la variable SalePrice tampoc hi ha NA.

En els atributs categòrics sí s'aprecien valors NA, en el cas de Fence, els NA equivaldrien a no fence, i s'observa que en tots els casos els valors NA formarien part del domini. Per exemple en els següents casos: NA= No Fence, NA=No Miscellaneous o que la casa no disposa de Garatge.

* Fence: Fence quality
		
       GdPrv	Good Privacy
       MnPrv	Minimum Privacy
       GdWo	Good Wood
       MnWw	Minimum Wood/Wire
       NA	No Fence

* MiscFeature: Miscellaneous feature not covered in other categories
		
       Elev	Elevator
       Gar2	2nd Garage (if not described in garage section)
       Othr	Other
       Shed	Shed (over 100 SF)
       TenC	Tennis Court
       NA	None


* GarageType:81 NA Garage location 81, el quan indica que l'any del garatge no pot omplir-se perquè no hi ha garatge. --GarageYrBlt: Year garage was built
		
       2Types	More than one type of garage
       Attchd	Attached to home
       Basment	Basement Garage
       BuiltIn	Built-In (Garage part of house - typically has room above garage)
       CarPort	Car Port
       Detchd	Detached from home
       NA	No Garage



## Reducció de dimensionalitat
Donat que es té una gran quantitat d'atributs: 81 atributs es fa una reducció de la dimensionalitat.

1.Donat que tenim 1460 observacions, es prescindeix dels atributs amb un nombre molt elevat de NA. (where NA >1000 NA) --> Alley, PoolQC, Fence, MiscFeature

```{r echo=TRUE, message=FALSE, warning=FALSE}
train = subset(train, select = -c(Alley,PoolQC,Fence,MiscFeature) )
```

2.Abans de fer matrius de correlació per a identificar i prescidir d'atributs amb una alta correlació entre ells (colinealitat) o amb molt poca correlació amb la variable Sale Price, es fa una prova de normalitat.

2.1.Normalitat de Sale Price que és la variable dependent.

Histograma: Per a veure les frequêncies. Es divideix per 1000 per a fer llegibles els preus. Els preus més freqüents estan entre 100k i 200k
```{r echo=TRUE, message=FALSE, warning=FALSE}
hist(train$SalePrice/1000, main="Sale Price")
```

Visualment no sembla seguir una distribució normal
```{r echo=TRUE, message=FALSE, warning=FALSE}
qqnorm(train$SalePrice, main="SalePrice") 
qqline(train$SalePrice,col=2)
```

Es confirma la manca de normalitat amb els tests de Kolmogorov-Smirnov i Shapiro-Wilk.
```{r echo=TRUE, message=FALSE, warning=FALSE}
ks.test(train$SalePrice, pnorm, mean(train$SalePrice), sd(train$SalePrice))
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
shapiro.test(train$SalePrice)
```
veiem com el p-value és menor a 0.05, el qual vol dir que hem de refusa la Hipòtesi 0 i per tant podem confirmar que hi ha un manca de normalitat.


2.2.A continuació es fa la prova de normalitat de les variables numèriques usant el mètode de Shapiro-Wilk:

```{r echo=TRUE, message=FALSE, warning=FALSE}
library(nortest)
train <- as.data.frame(train)
##---- **** encara no funciona!
alpha = 0.05 
col.names = colnames(train)
for (i in 1:ncol(train)) { 
        if (i == 1) cat("Variables que no segueixen una distribució normal:\n") 
        
        if (is.integer(train[,i]) | is.numeric(train[,i])) { 
                
               #p_val = ad.test(train[,i])$p.value
                p_val = shapiro.test(train[,i])$p.value 
                #  print(col.names[i])
               # print (p_val)
                if (p_val < alpha) {
                        cat (paste("No Normal: -- ", col.names[i]),"\r\n")
# Format output if (i < ncol(automoviles) - 1) cat(", ") if (i %% 3 == 0) cat("\n")
                }
               else{
                       cat (paste("Normal: -- ", col.names[i]),"\r\n")
               }
               
        }
                
} 
```

Per tant sembla que cap de les variables numèriques no segueix una distribució normal.

2.3.Tot seguit, comprovem la correlació entre els diferents atributs numèrics respecte a l'atribut SalePrice, aplicant la funció cor() que genera una matriu amb els percentatges de correlació entre les variables seleccionades.

```{r echo=TRUE, message=FALSE, warning=FALSE}
cor(train[,c('OverallQual','OverallCond','YearBuilt','YearRemodAdd','MasVnrArea','BsmtFinSF1','BsmtFinSF2','BsmtUnfSF','TotalBsmtSF','1stFlrSF','2ndFlrSF','LowQualFinSF','GrLivArea','BsmtFullBath','BsmtHalfBath','FullBath','HalfBath','BedroomAbvGr','KitchenAbvGr','TotRmsAbvGrd','Fireplaces','GarageYrBlt','GarageCars','GarageArea','WoodDeckSF','OpenPorchSF','EnclosedPorch','3SsnPorch','ScreenPorch','PoolArea','MiscVal','MoSold','YrSold','SalePrice')], train['SalePrice'])
```


En aquest cas com els atributs numèrics no segueixen una distribució normal, s'usa Spearman per a fer una matriu de correlació de les variables quantitatives amb la variable Sale Price. Prèviament es normalitzen els valors usant el mètode scale que usa una normalització de tipus z-score.


```{r echo=TRUE, message=FALSE, warning=FALSE}
train.scaled <- scale(train[,c('OverallQual','OverallCond','YearBuilt','YearRemodAdd','MasVnrArea','BsmtFinSF1','BsmtFinSF2','BsmtUnfSF','TotalBsmtSF','1stFlrSF','2ndFlrSF','LowQualFinSF','GrLivArea','BsmtFullBath','BsmtHalfBath','FullBath','HalfBath','BedroomAbvGr','KitchenAbvGr','TotRmsAbvGrd','Fireplaces','GarageYrBlt','GarageCars','GarageArea','WoodDeckSF','OpenPorchSF','EnclosedPorch','3SsnPorch','ScreenPorch','PoolArea','MiscVal','MoSold','YrSold','SalePrice')])
#es converteix a data frame
train.scaled <- as.data.frame(scale(train.scaled))
```

Spearman:

```{r echo=TRUE, message=FALSE, warning=FALSE}
corr_matrix <- matrix(nc = 2, nr = 0) 
colnames(corr_matrix) <- c("estimate", "p-value")
for (i in 1:(ncol(train.scaled) - 1)) { 
 if (is.integer(train.scaled[,i]) | is.numeric(train.scaled[,i])) { 
   spearman_test = cor.test(train.scaled[,i],
   train.scaled[,length(train.scaled)], method = "spearman") 
   corr_coef = spearman_test$estimate 
   p_val = spearman_test$p.value
# Add row to matrix 
   pair = matrix(ncol = 2, nrow = 1) 
   pair[1][1] = corr_coef 
   pair[2][1] = p_val 
   corr_matrix <- rbind(corr_matrix, pair) 
   rownames(corr_matrix)[nrow(corr_matrix)] <- colnames(train.scaled)[i]
  }
}
print(corr_matrix)
```


Les variables més fortament correlacionades, observades amb valors estimats més alts són:

* OverallQual: Rates the overall material and finish of the house
* GrLivArea: Above grade (ground) living area square feet
* YearBuilt: Original construction date
* GarageCars: Size of garage in car capacity
* GarageArea: Size of garage in square feet


Les variables menys interessants són les que tenen una estimació més a prop de 0. Per tal de reduir la dimensionalitat es pot prescindir de les variables entre -0.2 i 0.2 que no tindrien massa correlació amb el Sale Price:

* OverallCond
* BsmtFinSF2
* BsmtUnfSF
* LowQualFinSF
* BsmtHalfBath
* KitchenAbvGr
* 3SsnPorch
* ScreenPorch
* PoolArea
* MiscVal       
* MoSold
* YrSold

```{r echo=TRUE, message=FALSE, warning=FALSE}
train = subset(train, select = -c(OverallCond,BsmtFinSF2,BsmtUnfSF,LowQualFinSF,
BsmtHalfBath,BsmtHalfBath,KitchenAbvGr,`3SsnPorch`,ScreenPorch,PoolArea,
MiscVal,MoSold,YrSold) )
```

## Tractament d'outliers

### Identificació

#### Variable de classe-dependent: Sale Price

```{r echo=TRUE, message=FALSE, warning=FALSE}
summary(train$SalePrice)
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
boxplot.stats(train$SalePrice)$out
```

Observem com la majoria d'outliers són preus alts comparats amb la mitja que és de 163000. Es donen per valors vàlids, donat que s'observen característiques d'alt standing en aquestes cases, el que fa suposar que els valors són vàlids

```{r echo=TRUE, message=FALSE, warning=FALSE}
train.data = train[c("OverallQual","GrLivArea","YearBuilt","GarageCars","GarageArea","SalePrice")]


filter(train.data,SalePrice %in% (boxplot.stats(train$SalePrice)$out))
```


#### Variables independents:

Probablement són cases de finals del segle XIX.

```{r echo=TRUE, message=FALSE, warning=FALSE}
boxplot.stats(train$YearBuilt)$out
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
bp <-boxplot(train$BsmtFinSF1,main="Type 1 finished square feet") 
bp$out
#boxplot.stats(train$BsmtFinSF1)$out
```


```{r echo=TRUE, message=FALSE, warning=FALSE}
boxplot.stats(train$TotalBsmtSF)$out
```

Hi ha o un total de metres quadrats de la basement area (sotan) molt gran > 2000 o bé no hi ha sòtan i és 0

```{r echo=TRUE, message=FALSE, warning=FALSE}
boxplot.stats(train$`1stFlrSF`)$out
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
boxplot.stats(train$`2ndFlrSF`)$out
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
boxplot.stats(train$GrLivArea)$out
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
boxplot.stats(train$TotRmsAbvGrd)$out
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
boxplot.stats(train$Bedroom)$out
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
boxplot.stats(train$Fireplaces)$out
```
```{r echo=TRUE, message=FALSE, warning=FALSE}
boxplot.stats(train$GarageYrBlt)$out
```
quan no hi ha garatge l'any de construcció s'emplena amb un 0 que seria un outlier.

```{r echo=TRUE, message=FALSE, warning=FALSE}
boxplot.stats(train$GarageCars)$out
```
```{r echo=TRUE, message=FALSE, warning=FALSE}
boxplot.stats(train$GarageArea)$out
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
boxplot.stats(train$WoodDeckSF)$out
```
(Wood deck area in square feet outliers)


```{r echo=TRUE, message=FALSE, warning=FALSE}
boxplot.stats(train$OpenPorchSF)$out
```
 (Open porch area in square feet outliers)

```{r echo=TRUE, message=FALSE, warning=FALSE}
boxplot.stats(train$EnclosedPorch)$out
```

Enclosed porch area in square feet outliers: La mitja són 21.95 i el màxim 552 no havent-hi ni primer ni tercer quartil. Per tant podem dir que en la majoria de casos no hi ha enclosed porch, però quan hi ha és de molts metres quadrats.

### Anàlisi dels outliers:
Tots el outliers analitzats tenen sentint dintre del domini de cada atribut, per tant es decideix no aplicar cap mètode corrector.

## Creació de noves variables numèriques a partir de les categòriques
Abans hem trobat la correlació de les variables numèriques amb SalePrice fent servir la funció cor() i la correlació d'Spearman. Ara, intentarem fer el mateix però amb les variables categòriques.

Per tal d'aconseguir-ho crearem nous atributs numèrics a partir dels atributs categòrics existents. Això ho podrem fer revisant cadascuna de les variables i definint uns valors numèrics que descriguin de forma equivalent les categories representades.

La nomenclatura que farem servir per assignar aquests nous atributs serà **vn** al principi del nom, per tal d'indicar que es tracta d'un valor numèric.

Començarem per la variable Street, que té dos possibles valors: Grvl o Pave; és a dir el camí d'accés a la vivenda pot ser de grava o pavimentat.

```{r vn_Street, echo=TRUE, message=FALSE, warning=FALSE}
#Comprovem els possibles valors de la variable Street
table(train$Street)
#Creem la nova variable numèrica assignant 1 o 0 en funció de si el carrer està pavimentat (1) o no (0)
train$vnStreet[train$Street == "Pave"] <- 1
train$vnStreet[train$Street != "Pave"] <- 0
```

L'atribut LotShape ens descriu la forma de la vivenda en 4 nivells desde regular (millor) fins a irregular (pitjor).

```{r vn_LotShape, echo=TRUE, message=FALSE, warning=FALSE}
#Comprovem els possibles valors de la variable LotShape
table(train$LotShape)
#Creem la nova variable numèrica que pot agafar 4 possibles valors: regular(4), una mica irregular (3), bastant irregular (2), irregular (1)
train$vnLotShape[train$LotShape == "Reg"] <- 4
train$vnLotShape[train$LotShape == "IR1"] <- 3
train$vnLotShape[train$LotShape == "IR2"] <- 2
train$vnLotShape[train$LotShape == "IR3"] <- 1
```

LandContour indica el desnivell de la vivenda.

```{r vn_LandContour, echo=TRUE, message=FALSE, warning=FALSE}
#Comprovem els possibles valors de la variable LandContour
table(train$LandContour)
#Creem la nova variable numèrica en la que considerarem únicament dos possibles valors: a nivell (1) o amb desnivell (0)
train$vnLandContour[train$LandContour == "Lvl"] <- 1
train$vnLandContour[train$LandContour != "Lvl"] <- 0
```

Utilities descriu els serveis de que consta la vivenda.

```{r vn_Utilities, echo=TRUE, message=FALSE, warning=FALSE}
#Comprovem els possibles valors de la variable Utilities
table(train$Utilities)
#La nova variable numèrica prendrà 4 possibles valors: AllPub(4), NoSewr(3), NoSeWa(2), ELO(1)
train$vnUtilities[train$Utilities == "AllPub"] <- 4
train$vnUtilities[train$Utilities == "NoSewr"] <- 3
train$vnUtilities[train$Utilities == "NoSeWa"] <- 2
train$vnUtilities[train$Utilities == "ELO"] <- 1
```

LandSlope indica el pendent del terreny.

```{r vn_LandSlope, echo=TRUE, message=FALSE, warning=FALSE}
#Comprovem els possibles valors de la variable LandSlope
table(train$LandSlope)
#La nova variable numèrica prendrà 3 possibles valors: Gtl(3), Mod(2), Sev(1)
train$vnLandSlope[train$LandSlope == "Gtl"] <- 3
train$vnLandSlope[train$LandSlope == "Mod"] <- 2
train$vnLandSlope[train$LandSlope == "Sev"] <- 1
```

Amb LotConfig per tal de donar un valor numèric que tingui sentit, tenint en compte que no es pot establir cap ordre de millor o pitjor per a la configuració de la propietat, el que farem es fixar-nos en el preu mig per a cada tipus de configuració. D'aquesta manera podrem ordenar de la configuració més cara a la més barata les vivendes.

```{r vn_LotConfig, echo=TRUE, message=FALSE, warning=FALSE}
#Comprovem quin és el SalePrice mig per a cadascuna de les configuracions
summarize(group_by(train, LotConfig), mean(SalePrice, na.rm=T))
#Ara assignem 5 possibles valors numèrics a la nova variable, seguint un ordre de configuració més valuosa a menys: CulDSac(5), FR3(4), Corner(3), FR2(2), Inside(1)
train$vnLotConfig[train$LotConfig == "CulDSac"] <- 5
train$vnLotConfig[train$LotConfig == "FR3"] <- 4
train$vnLotConfig[train$LotConfig == "Corner"] <- 3
train$vnLotConfig[train$LotConfig == "FR2"] <- 2
train$vnLotConfig[train$LotConfig == "Inside"] <- 1
```

Per assignar un valor numèric a l'atribut Neighborhood farem el mateix. Definirem el preu mig de venta de les vivendes de cada veïnat, i a continuació classificarem aquests barris en 3 grups en funció del preu mig de les vivendes entre barats(1), preu mitjà(2) i cars(3).

```{r vn_neighborhood, echo=TRUE, message=FALSE, warning=FALSE}
#Comprovem quin és el preu de venta mig per a les vivendes de cadascun dels barris
nbhdprice <- summarize(group_by(train, Neighborhood),mean(SalePrice, na.rm=T))
#Definim com a barri barat (nbhdprice_lo) els barris amb un preu mitjà inferior a 140.000, barri mitjà (nbhdprice_med) els que tenen un preu entre 140.000 i 200.000 i barri car (nbhdprice_hi) els que les propietats tenen un preu superior a 200.000
nbhdprice_lo <- filter(nbhdprice, nbhdprice$`mean(SalePrice, na.rm = T)` < 140000)
nbhdprice_med <- filter(nbhdprice, nbhdprice$`mean(SalePrice, na.rm = T)` < 200000 & nbhdprice$`mean(SalePrice, na.rm = T)` >= 140000 )
nbhdprice_hi <- filter(nbhdprice, nbhdprice$`mean(SalePrice, na.rm = T)` >= 200000)
#Finalment assignem 3 possibles valors depenent del tipus de veinat: nbhdprice_hi(3), nbhdprice_med(2), nbhdprice_lo(1)
train$vnNeighborhood[train$Neighborhood %in% nbhdprice_lo$Neighborhood] <- 1
train$vnNeighborhood[train$Neighborhood %in% nbhdprice_med$Neighborhood] <- 2
train$vnNeighborhood[train$Neighborhood %in% nbhdprice_hi$Neighborhood] <- 3
```

Els atributs Condition1 i Condition2 els convertirem a valors numèrics d'igual forma. I farem servir el mateix mètode que en els anteriors casos, comprovant el preu de venta mig per a cadascuna de les categories i establint un ordre per a que els valors numèrics tinguin sentit.

```{r vn_conditions, echo=TRUE, message=FALSE, warning=FALSE}
#Comprovem SalePrice per cada opció
summarize(group_by(train, Condition1),mean(SalePrice, na.rm=T))
summarize(group_by(train, Condition2),mean(SalePrice, na.rm=T))
#A partir del resultat anterior veiem que PosA i PosN tenen un preu més elevat i es diferencien de la resta tant en Condition1 com en Condition2. Definim dos valors numèrics 1 i 0, en funció de si l'atribut té valor PosA o PosN o no.
train$vnCondition1[train$Condition1 %in% c("PosA", "PosN")] <- 1
train$vnCondition1[!train$Condition1 %in% c("PosA", "PosN")] <- 0
train$vnCondition2[train$Condition2 %in% c("PosA", "PosN")] <- 1
train$vnCondition2[!train$Condition2 %in% c("PosA", "PosN")] <- 0
```

BldgType indica el tipus de construcció

```{r vn_BldgType, echo=TRUE, message=FALSE, warning=FALSE}
#Comprovem quin és el SalePrice mig per a cada BldgType
summarize(group_by(train, BldgType), mean(SalePrice, na.rm=T))
#Ara assignem valors numèrics a la nova variable, seguint un ordre de tipus d'edificació de més valuosa a menys: 1Fam(5), TwnhsE(4), Twnhs(3), Duplex(2), 2fmCon(1)
train$vnBldgType[train$BldgType == "1Fam"] <- 5
train$vnBldgType[train$BldgType == "TwnhsE"] <- 4
train$vnBldgType[train$BldgType == "Twnhsr"] <- 3
train$vnBldgType[train$BldgType == "Duplex"] <- 2
train$vnBldgType[train$BldgType == "2fmCon"] <- 1
```

HouseStyle descriu el tipus de vivenda

```{r vn_HouseStyle, echo=TRUE, message=FALSE, warning=FALSE}
#Comprovem quin és el SalePrice mig per a cada HouseStyle
housestyle_price <- summarize(group_by(train, HouseStyle), mean(SalePrice, na.rm=T))
#Definim 3 categories en funció si el preu és inferior a 140.000 (housestyle_lo), es troba entre 140.000 i 200.000 (housestyle_med), o és superior a 200.000 (housestyle_hi)
housestyle_lo <- filter(housestyle_price, housestyle_price$`mean(SalePrice, na.rm = T)` < 140000)
housestyle_med <- filter(housestyle_price, housestyle_price$`mean(SalePrice, na.rm = T)` < 200000 & housestyle_price$`mean(SalePrice, na.rm = T)` >= 140000 )
housestyle_hi <- filter(housestyle_price, housestyle_price$`mean(SalePrice, na.rm = T)` >= 200000)
#Finalment assignem 3 possibles valors depenent del tipus d'habitatge: housestyle_hi(3), housestyle_med(2), housestyle_lo(1)
train$vnHouseStyle[train$HouseStyle %in% housestyle_lo$HouseStyle] <- 1
train$vnHouseStyle[train$HouseStyle %in% housestyle_med$HouseStyle] <- 2
train$vnHouseStyle[train$HouseStyle %in% housestyle_hi$HouseStyle] <- 3
```

RoofStyle descriu el tipus de teulada.

```{r vn_RoofStyle, echo=TRUE, message=FALSE, warning=FALSE}
#Comprovem quin és el SalePrice mig per a cada RoofStyle
summarize(group_by(train, RoofStyle), mean(SalePrice, na.rm=T))
#Ara assignem valors numèrics a la nova variable, seguint un ordre de tipus de teulada de més valuosa a menys: Shed(6), Hip(5), Flat(4), Mansard(3), Gable(2), Gambrel(1)
train$vnRoofStyle[train$RoofStyle == "Shed"] <- 6
train$vnRoofStyle[train$RoofStyle == "Hip"] <- 5
train$vnRoofStyle[train$RoofStyle == "Flat"] <- 4
train$vnRoofStyle[train$RoofStyle == "Mansard"] <- 3
train$vnRoofStyle[train$RoofStyle == "Gable"] <- 2
train$vnRoofStyle[train$RoofStyle == "Gambrel"] <- 1
```

RoofMatl descriu el material amb que està feta la teulada.

```{r vn_RoofMatl, echo=TRUE, message=FALSE, warning=FALSE}
#Comprovem quina és la mitja del SalePrice per cada RoofMatl
summarize(group_by(train, RoofMatl), mean(SalePrice, na.rm=T))
#Assignem valor 1 o 0 a cada material en funció de si la mitja del preu de venta de les vivendes amb teulades construides amb aquell material és superior a 200.000 (1) o inferior (0).
train$vnRoofMatl[train$RoofMatl %in% c("Membran", "WdShake", "WdShngl")] <- 1
train$vnRoofMatl[!train$RoofMatl %in% c("Membran", "WdShake", "WdShngl")] <- 0
```

Exterior1st i Exterior2nd descriuen el tipus d'acabats del recobriment exterior de les parets de la vivenda.

```{r vn_Exteriors, echo=TRUE, message=FALSE, warning=FALSE}
#Comprovem quina és la mitja del SalePrice per a cada tipus d'Exterior1st
ext1_price <- summarize(group_by(train, Exterior1st), mean(SalePrice, na.rm=T))
#Definim 3 categories en funció si el preu és inferior a 140.000 (ext1_lo), es troba entre 140.000 i 200.000 (ext1_med), o és superior a 200.000 (ext1_hi)
ext1_lo <- filter(ext1_price, ext1_price$`mean(SalePrice, na.rm = T)` < 140000)
ext1_med <- filter(ext1_price, ext1_price$`mean(SalePrice, na.rm = T)` < 200000 & ext1_price$`mean(SalePrice, na.rm = T)` >= 140000 )
ext1_hi <- filter(ext1_price, ext1_price$`mean(SalePrice, na.rm = T)` >= 200000)
#Finalment assignem 3 possibles valors depenent del tipus d'exterior: ext1_hi(3), ext1_med(2), ext1_lo(1)
train$vnExterior1st[train$Exterior1st %in% ext1_lo$Exterior1st] <- 1
train$vnExterior1st[train$Exterior1st %in% ext1_med$Exterior1st] <- 2
train$vnExterior1st[train$Exterior1st %in% ext1_hi$Exterior1st] <- 3
#Comprovem quina és la mitja del SalePrice per a cada tipus d'Exterior2nd
ext2_price <- summarize(group_by(train, Exterior2nd), mean(SalePrice, na.rm=T))
#Definim 3 categories en funció si el preu és inferior a 140.000 (ext2_lo), es troba entre 140.000 i 200.000 (ext2_med), o és superior a 200.000 (ext2_hi)
ext2_lo <- filter(ext2_price, ext2_price$`mean(SalePrice, na.rm = T)` < 140000)
ext2_med <- filter(ext2_price, ext2_price$`mean(SalePrice, na.rm = T)` < 200000 & ext2_price$`mean(SalePrice, na.rm = T)` >= 140000 )
ext2_hi <- filter(ext2_price, ext2_price$`mean(SalePrice, na.rm = T)` >= 200000)
#Finalment assignem 3 possibles valors depenent del tipus d'exterior: ext1_hi(3), ext1_med(2), ext1_lo(1)
train$vnExterior2nd[train$Exterior2nd %in% ext2_lo$Exterior2nd] <- 1
train$vnExterior2nd[train$Exterior2nd %in% ext2_med$Exterior2nd] <- 2
train$vnExterior2nd[train$Exterior2nd %in% ext2_hi$Exterior2nd] <- 3
```

MasVnrType indica el tipus de mamposteria.

```{r vn_MasVnrType, echo=TRUE, message=FALSE, warning=FALSE}
#Comprovem quina és la mitja del SalePrice per cada MasVnrType
summarize(group_by(train, MasVnrType),mean(SalePrice, na.rm=T))
```

Observem que hi han valors NA.

```{r vn_MasVnrType2, echo=TRUE, message=FALSE, warning=FALSE}
#Assignem valor 1 o 0 a cada material en funció de si la mitja del preu de venta de les vivendes amb mamposteria feta amb aquell material és superior a 200.000 (1) o inferior (0). 
train$vnMasVnrType[train$MasVnrType %in% c("Stone", "BrkFace") | is.na(train$MasVnrType)] <- 1
train$vnMasVnrType[!train$MasVnrType %in% c("Stone", "BrkFace") & !is.na(train$MasVnrType)] <- 0
```

ExterQual, ens diu la qualitat dels materials emprats en els exteriors.

```{r vn_ExterQual, echo=TRUE, message=FALSE, warning=FALSE}
#Assignem valors numèrics de més qualitat a menys: Excellent (5), Good (4), Average/Typical (3), Fair(2), Poor (1)
train$vnExterQual[train$ExterQual == "Ex"] <- 5
train$vnExterQual[train$ExterQual == "Gd"] <- 4
train$vnExterQual[train$ExterQual == "TA"] <- 3
train$vnExterQual[train$ExterQual == "Fa"] <- 2
train$vnExterQual[train$ExterQual == "Po"] <- 1
```

ExterCond indica l'estat actual dels materials emprats en els exteriors.

```{r vn_ExterCond, echo=TRUE, message=FALSE, warning=FALSE}
#Assignem valors numèrics de més qualitat a menys: Excellent (5), Good (4), Average/Typical (3), Fair(2), Poor (1)
train$vnExterCond[train$ExterCond == "Ex"] <- 5
train$vnExterCond[train$ExterCond == "Gd"] <- 4
train$vnExterCond[train$ExterCond == "TA"] <- 3
train$vnExterCond[train$ExterCond == "Fa"] <- 2
train$vnExterCond[train$ExterCond == "Po"] <- 1
```

Foundation indica el tipus de fonaments de la vivenda.

```{r vn_Foundation, echo=TRUE, message=FALSE, warning=FALSE}
#Comprovem quin és el SalePrice mig per a cada tipus de fonaments.
summarize(group_by(train, Foundation), mean(SalePrice, na.rm=T))
#Ara assignem valors numèrics a la nova variable, seguint un ordre dels fonaments més valorats als que menys: PConc(6), Wood(5), Stone(4), CBlock(3), BrkTil(2), Slab(1)
train$vnFoundation[train$Foundation == "PConc"] <- 6
train$vnFoundation[train$Foundation == "Wood"] <- 5
train$vnFoundation[train$Foundation == "Stone"] <- 4
train$vnFoundation[train$Foundation == "CBlock"] <- 3
train$vnFoundation[train$Foundation == "BrkTil"] <- 2
train$vnFoundation[train$Foundation == "Slab"] <- 1
```

BsmtQual, indica la qualitat del soterrani en funció de la seva alçada.

```{r vn_BsmtQual, echo=TRUE, message=FALSE, warning=FALSE}
#Assignem valors numèrics de més qualitat a menys: Excellent (6), Good (5), Typical (4), Fair (3), Poor (2), No Basement (1)
train$vnBsmtQual[train$BsmtQual == "Ex"] <- 6
train$vnBsmtQual[train$BsmtQual == "Gd"] <- 5
train$vnBsmtQual[train$BsmtQual == "TA"] <- 4
train$vnBsmtQual[train$BsmtQual == "Fa"] <- 3
train$vnBsmtQual[train$BsmtQual == "Po"] <- 2
train$vnBsmtQual[is.na(train$BsmtQual)] <- 1
```

BsmtCond, fa una evaluació general de les condicions actuals del soterrani.

```{r vn_BsmtCond, echo=TRUE, message=FALSE, warning=FALSE}
#Assignem valors numèrics de més qualitat a menys: Excellent (6), Good (5), Typical (4), Fair (3), Poor (2), No Basement (1)
train$vnBsmtCond[train$BsmtCond == "Ex"] <- 6
train$vnBsmtCond[train$BsmtCond == "Gd"] <- 5
train$vnBsmtCond[train$BsmtCond == "TA"] <- 4
train$vnBsmtCond[train$BsmtCond == "Fa"] <- 3
train$vnBsmtCond[train$BsmtCond == "Po"] <- 2
train$vnBsmtCond[is.na(train$BsmtCond)] <- 1
```

BsmtExposure fa referència a la visibilitat del soterrani.

```{r vn_BsmtExposure, echo=TRUE, message=FALSE, warning=FALSE}
#Assignem valors numèrics de més qualitat a menys: Good Exposure (5), Average Exposure (4), Minimum Exposure (3), No Exposure (2), No Basement (1)
train$vnBsmtExposure[train$BsmtExposure == "Gd"] <- 5
train$vnBsmtExposure[train$BsmtExposure == "Av"] <- 4
train$vnBsmtExposure[train$BsmtExposure == "Mn"] <- 3
train$vnBsmtExposure[train$BsmtExposure == "No"] <- 2
train$vnBsmtExposure[is.na(train$BsmtExposure)] <- 1
```

BsmtFinType1 i BsmtFinType2 fa referència a la qualitat del soterrani i la seva habitabilitat.

```{r vn_BsmtFinType, echo=TRUE, message=FALSE, warning=FALSE}
#Assignem valors numèrics de més qualitat a menys: Good Living Quarters (7), Average Living Quarters (6), Below Average Living Quarters (5), Average Rec Room (4), Low Quality (3), Unfinished (2), No Basement (1)
train$vnBsmtFinType1[train$BsmtFinType1 == "GLQ"] <- 7
train$vnBsmtFinType1[train$BsmtFinType1 == "ALQ"] <- 6
train$vnBsmtFinType1[train$BsmtFinType1 == "BLQ"] <- 5
train$vnBsmtFinType1[train$BsmtFinType1 == "Rec"] <- 4
train$vnBsmtFinType1[train$BsmtFinType1 == "LwQ"] <- 3
train$vnBsmtFinType1[train$BsmtFinType1 == "Unf"] <- 2
train$vnBsmtFinType1[is.na(train$BsmtFinType1)] <- 1
train$vnBsmtFinType2[train$BsmtFinType2 == "GLQ"] <- 7
train$vnBsmtFinType2[train$BsmtFinType2 == "ALQ"] <- 6
train$vnBsmtFinType2[train$BsmtFinType2 == "BLQ"] <- 5
train$vnBsmtFinType2[train$BsmtFinType2 == "Rec"] <- 4
train$vnBsmtFinType2[train$BsmtFinType2 == "LwQ"] <- 3
train$vnBsmtFinType2[train$BsmtFinType2 == "Unf"] <- 2
train$vnBsmtFinType2[is.na(train$BsmtFinType2)] <- 1
```

Heating descriu el tipus de calefacció.

```{r vn_Heating, echo=TRUE, message=FALSE, warning=FALSE}
#Comprovem quin és el SalePrice mig per a cada tipus de calefacció
summarize(group_by(train, Heating), mean(SalePrice, na.rm=T))
#Ara assignem valors numèrics a la nova variable, seguint un ordre del tipus de calefacció que dóna més valor a la vivenda al que menys: GasA(6), GasW(5), OthW(4), Wall(3), Grav(2), Floor(1)
train$vnHeating[train$Heating == "GasA"] <- 6
train$vnHeating[train$Heating == "GasW"] <- 5
train$vnHeating[train$Heating == "OthW"] <- 4
train$vnHeating[train$Heating == "Wall"] <- 3
train$vnHeating[train$Heating == "Grav"] <- 2
train$vnHeating[train$Heating == "Floor"] <- 1
```

HeatingQC ens diu la qualitat i l'estat de la instal·lació de la calefacció.

```{r vn_HeatingQC, echo=TRUE, message=FALSE, warning=FALSE}
#Assignem valors numèrics de més qualitat a menys: Excellent (5), Good (4), Average/Typical (3), Fair (2), Poor (1)
train$vnHeatingQC[train$HeatingQC == "Ex"] <- 5
train$vnHeatingQC[train$HeatingQC == "Gd"] <- 4
train$vnHeatingQC[train$HeatingQC == "TA"] <- 3
train$vnHeatingQC[train$HeatingQC == "Fa"] <- 2
train$vnHeatingQC[train$HeatingQC == "Po"] <- 1
```

CentralAir indica si l'habitatge té aire acondicionat central.

```{r vn_CentralAir, echo=TRUE, message=FALSE, warning=FALSE}
#Assignem el valor 1 si té AC i 0 si no en té.
train$vnCentralAir[train$CentralAir == "Y"] <- 1
train$vnCentralAir[train$CentralAir == "N"] <- 0
```

Electrical descriu el tipus d'instal·lació elèctrica de la vivenda.

```{r vn_Electrical, echo=TRUE, message=FALSE, warning=FALSE}
#Comprovem quin és el SalePrice mig de les vivendes per a cada tipus d'instal·lació
summarize(group_by(train, Electrical), mean(SalePrice, na.rm=T))
#Ara assignem valors numèrics a la nova variable, seguint un ordre del tipus d'instal·lació que dóna més valor a la vivenda al que menys: SBrkr(6), NA(5), FuseA(4), FuseF(3), FuseP(2), Mix(1)
train$vnElectrical[train$Electrical == "SBrkr"] <- 6
train$vnElectrical[is.na(train$Electrical)] <- 5
train$vnElectrical[train$Electrical == "FuseA"] <- 4
train$vnElectrical[train$Electrical == "FuseF"] <- 3
train$vnElectrical[train$Electrical == "FuseP"] <- 2
train$vnElectrical[train$Electrical == "Mix"] <- 1
```

KitchenQual, valora la qualitat general de la cuina.

```{r vn_KitchenQual, echo=TRUE, message=FALSE, warning=FALSE}
#Assignem valors numèrics de més qualitat a menys: Excellent (5), Good (4), Average/Typical (3), Fair (2), Poor (1)
train$vnKitchenQual[train$KitchenQual == "Ex"] <- 5
train$vnKitchenQual[train$KitchenQual == "Gd"] <- 4
train$vnKitchenQual[train$KitchenQual == "TA"] <- 3
train$vnKitchenQual[train$KitchenQual == "Fa"] <- 2
train$vnKitchenQual[train$KitchenQual == "Po"] <- 1
```

FireplaceQu, indica la qualitat del foc a terra.

```{r vn_FireplaceQu, echo=TRUE, message=FALSE, warning=FALSE}
#Assignem valors numèrics de més qualitat a menys: Excellent (6), Good (5), Average (4), Fair (3), Poor (2), No Fireplace (1)
train$vnFireplaceQu[train$FireplaceQu == "Ex"] <- 6
train$vnFireplaceQu[train$FireplaceQu == "Gd"] <- 5
train$vnFireplaceQu[train$FireplaceQu == "TA"] <- 4
train$vnFireplaceQu[train$FireplaceQu == "Fa"] <- 3
train$vnFireplaceQu[train$FireplaceQu == "Po"] <- 2
train$vnFireplaceQu[is.na(train$FireplaceQu)] <- 1
```

GarageType, tipus de garatge.

```{r vn_GarageType, echo=TRUE, message=FALSE, warning=FALSE}
#Comprovem quin és el SalePrice mig de les vivendes segons el tipus de garatge
summarize(group_by(train, GarageType), mean(SalePrice, na.rm=T))
#Ara assignem valors numèrics a la nova variable, seguint un ordre del tipus de garatge que dóna més valor a la vivenda al que menys: BuiltIn(7), Attached(6), Basement(5), More than one type(4), Detached(3), Car Port(2), No Garage(1)
train$vnGarageType[train$GarageType == "BuiltIn"] <- 7
train$vnGarageType[train$GarageType == "Attchd"] <- 6
train$vnGarageType[train$GarageType == "Basment"] <- 5
train$vnGarageType[train$GarageType == "2Types"] <- 4
train$vnGarageType[train$GarageType == "Detchd"] <- 3
train$vnGarageType[train$GarageType == "CarPort"] <- 2
train$vnGarageType[is.na(train$GarageType)] <- 1
```

GarageFinish, ens diu si l'interior del garatge està acabat o no.

```{r vn_GarageFinish, echo=TRUE, message=FALSE, warning=FALSE}
#Assignem valors numèrics en funció del grau dels acabats del garatge: Finished (4), Rough Finished (3), Unfinished (2), No Garage (1)
train$vnGarageFinish[train$GarageFinish == "Fin"] <- 4
train$vnGarageFinish[train$GarageFinish == "RFn"] <- 3
train$vnGarageFinish[train$GarageFinish == "Unf"] <- 2
train$vnGarageFinish[is.na(train$GarageFinish)] <- 1
```

GarageQual, indica la qualitat general del garatge.

```{r vn_GarageQual, echo=TRUE, message=FALSE, warning=FALSE}
#Assignem valors numèrics de més qualitat a menys: Excellent (6), Good (5), Average (4), Fair (3), Poor (2), No Garage (1)
train$vnGarageQual[train$GarageQual == "Ex"] <- 6
train$vnGarageQual[train$GarageQual == "Gd"] <- 5
train$vnGarageQual[train$GarageQual == "TA"] <- 4
train$vnGarageQual[train$GarageQual == "Fa"] <- 3
train$vnGarageQual[train$GarageQual == "Po"] <- 2
train$vnGarageQual[is.na(train$GarageQual)] <- 1
```

GarageCond, indica l'estat actual del garatge.

```{r vn_GarageCond, echo=TRUE, message=FALSE, warning=FALSE}
#Assignem valors numèrics de més qualitat a menys: Excellent (6), Good (5), Average (4), Fair (3), Poor (2), No Garage (1)
train$vnGarageCond[train$GarageCond == "Ex"] <- 6
train$vnGarageCond[train$GarageCond == "Gd"] <- 5
train$vnGarageCond[train$GarageCond == "TA"] <- 4
train$vnGarageCond[train$GarageCond == "Fa"] <- 3
train$vnGarageCond[train$GarageCond == "Po"] <- 2
train$vnGarageCond[is.na(train$GarageCond)] <- 1
```

PavedDrive indica si la calçada està asfaltada.

```{r vn_PavedDrive, echo=TRUE, message=FALSE, warning=FALSE}
#Hi han 3 possibles valors: Paved (3), Partial Pavement (2), Dirt/Gravel (1)
train$vnPavedDrive[train$PavedDrive == "Y"] <- 3
train$vnPavedDrive[train$PavedDrive == "P"] <- 2
train$vnPavedDrive[train$PavedDrive == "N"] <- 1
```

Functional, indica la funcionalitat de l'habitatge (assumeix la opció Typical si no hi ha cap deducció garantida).

```{r vn_Functional, echo=TRUE, message=FALSE, warning=FALSE}
train$vnFunctional[train$Functional == "Typ"] <- 1
train$vnFunctional[train$Functional != "Typ"] <- 0
```

SaleType fa referència al tipus de venta.

```{r vn_SaleType, echo=TRUE, message=FALSE, warning=FALSE}
#Comprovem quin és el preu mitjà de venta per a les vivendes en funció del tipus de venta
summarize(group_by(train, SaleType), mean(SalePrice, na.rm=T))
#Ara assignem valors numèrics i agrupem les variables que observem que tenen preus mitjans de venta semblants.
test$vnSaleType[test$SaleType %in% c("New", "Con")] <- 5
test$vnSaleType[test$SaleType %in% c("CWD", "ConLI")] <- 4
test$vnSaleType[test$SaleType %in% c("WD")] <- 3
test$vnSaleType[test$SaleType %in% c("COD", "ConLw", "ConLD")] <- 2
test$vnSaleType[test$SaleType %in% c("Oth")] <- 1
```

SaleCondition descriu les condicions en que s'ha realitzat la venta.

```{r vn_SaleCondition, echo=TRUE, message=FALSE, warning=FALSE}
#Comprovem quin és el preu mitjà de venta per a les vivendes en funció de la condició de venta
summarize(group_by(train, SaleCondition), mean(SalePrice, na.rm=T))
#Ara assignem valors numèrics a les variables
train$vnSaleCondition[train$SaleCondition == "Partial"] <- 6
train$vnSaleCondition[train$SaleCondition == "Normal"] <- 5
train$vnSaleCondition[train$SaleCondition == "Alloca"] <- 4
train$vnSaleCondition[train$SaleCondition == "Family"] <- 3
train$vnSaleCondition[train$SaleCondition == "Abnorml"] <- 2
train$vnSaleCondition[train$SaleCondition == "Adjland"] <- 1
```

MSZoning identifica el tipus de zona on es realitza la venta.

```{r vn_MSZoning, echo=TRUE, message=FALSE, warning=FALSE}
#Comprovem quin és el preu mitjà de venta per a les vivendes en funció de la zona de venta
summarize(group_by(train, MSZoning), mean(SalePrice, na.rm=T))
#Ara assignem valors numèrics a les variables
test$vnMSZoning[test$MSZoning %in% c("FV")] <- 5
test$vnMSZoning[test$MSZoning %in% c("RL")] <- 4
test$vnMSZoning[test$MSZoning %in% c("RH")] <- 3
test$vnMSZoning[test$MSZoning %in% c("RM")] <- 2
test$vnMSZoning[test$MSZoning %in% c("C (all)")] <- 1
```

MSSubClass identifica el tipus de vivenda venuda.

```{r vn_MSSubClass, echo=TRUE, message=FALSE, warning=FALSE}
#Comprovem quin és el preu de venta mig per a les vivendes de cada tipus
subclassprice <- summarize(group_by(train, MSSubClass),mean(SalePrice, na.rm=T))
#Definim com a tipus de vivenda barata (subclass_lo) les propietats amb un preu mitjà inferior a 140.000, vivenda assequible (subclass_med) les que tenen un preu entre 140.000 i 200.000 i propietat cara (subclass_hi) els tipus de propietats que tenen un preu superior a 200.000
subclass_lo <- filter(subclassprice, subclassprice$`mean(SalePrice, na.rm = T)` < 140000)
subclass_med <- filter(subclassprice, subclassprice$`mean(SalePrice, na.rm = T)` < 200000 & subclassprice$`mean(SalePrice, na.rm = T)` >= 140000 )
subclass_hi <- filter(subclassprice, subclassprice$`mean(SalePrice, na.rm = T)` >= 200000)
#Finalment assignem 3 possibles valors: subclass_hi(3), subclass_med(2), subclass_lo(1)
train$vnMSSubClass[train$MSSubClass %in% subclass_lo$MSSubClass] <- 1
train$vnMSSubClass[train$MSSubClass %in% subclass_med$MSSubClass] <- 2
train$vnMSSubClass[train$MSSubClass %in% subclass_hi$MSSubClass] <- 3
```

A continuació s'observala correlació, donat que a les variables numèriques no seguien una distribució normal, s'aplica també Spearman sobre les variables transformades vn, afegint SalePrice al final com a variable dependent

```{r echo=TRUE, message=FALSE, warning=FALSE}
train.vn <- train[,c("vnStreet","vnLotShape","vnLandContour","vnUtilities",
"vnLandSlope","vnLotConfig","vnNeighborhood","vnCondition1","vnCondition2","vnBldgType",
"vnHouseStyle","vnRoofStyle","vnRoofMatl","vnExterior1st","vnExterior2nd",
"vnMasVnrType","vnExterQual","vnExterCond","vnFoundation","vnBsmtQual","vnBsmtCond",
"vnBsmtExposure" ,"vnBsmtFinType1","vnBsmtFinType2","vnHeating","vnHeatingQC",
"vnCentralAir","vnElectrical","vnKitchenQual" ,"vnFireplaceQu","vnGarageType",
"vnGarageFinish","vnGarageQual","vnGarageCond","vnPavedDrive","vnFunctional",
"vnSaleCondition","SalePrice")]
```

Spearman en les variables vn

```{r echo=TRUE, message=FALSE, warning=FALSE}
corr_matrix <- matrix(nc = 2, nr = 0) 
colnames(corr_matrix) <- c("estimate", "p-value")
for (i in 1:(ncol(train.vn) - 1)) { 
# if( substr(colnames(train.vn[i]), start=1, stop=2)=="vn")
 # { 
   spearman_test = cor.test(train.vn[,i],
   train.vn[,length(train.vn)], method = "spearman") 
   corr_coef = spearman_test$estimate 
   p_val = spearman_test$p.value
# Add row to matrix 
   pair = matrix(ncol = 2, nrow = 1) 
   pair[1][1] = corr_coef 
   pair[2][1] = p_val 
   corr_matrix <- rbind(corr_matrix, pair) 
   rownames(corr_matrix)[nrow(corr_matrix)] <- colnames(train.vn)[i]
  #}
}
print(corr_matrix)

```

Les variables categòriques més correlacionades amb el Preu són:

* vnNeighborhood: Barri. (Agrupació de barris en 3 grups segons el preu mitjà de les cases.)
* vnExterQual: Qualtitat del material al exterior      
* vnKitchenQual: Qualitat de la cuina
* vnBsmtQual: Evalua el gruix del pis que està directament relacionat amb la qualitat.
* vnGarageFinish: Mesura la qualitat del garatge


Recordem també les variables numèriques més correlacionades eren:

* OverallQual: Rates the overall material and finish of the house
* GrLivArea: Above grade (ground) living area square feet
* YearBuilt: Original construction date
* GarageCars: Size of garage in car capacity
* GarageArea: Size of garage in square feet

A continuació s'analitza la colinealitat entre aquestes variables en dos cops:

```{r echo=TRUE, message=FALSE, warning=FALSE}
pairs(~vnGarageFinish+GarageCars+GarageArea+GrLivArea+YearBuilt,data=train,
   main="anàlisis colinearitat")
```

S'observa certa correlació entre Garage Area i YearBuilt.

```{r echo=TRUE, message=FALSE, warning=FALSE}
pairs(~vnNeighborhood+vnExterQual+vnKitchenQual+vnBsmtQual+
        OverallQual+GrLivArea,data=train,
   main="anàlisis colinearitat")
```

s'observa una colinearitat molt més clara entre GrLivArea i OverallQual. 


## Comparació de barris en relació al preu de venda (Comparació de grups)
A la fase de creació de variables numèriques a partir de qualitatives es va veure que es podia establir un ordre en els barris d'acord amb el seu preu mitjà. A continuació es fa una prova d'hipòtesi per a comparar aquests barris com grups i determinar si són iguals en quant a la seva mitjana i homoscedasticitat. Com  ja vam veure, la variable SalePrice no seguexi una distribució normal, a continuació es fa la prova d'homoscedasticitat  amb el test de Fligner-Killeen. 

Establim com a Hipòtesi 0 que les variances són iguals amb un nivell de confiança d'un 95% (nivell de significació per defecte 0.05)

```{r echo=TRUE, message=FALSE, warning=FALSE}
 fligner.test(SalePrice ~ Neighborhood, data = train)
```

Com que el p-value <0.05 es rebutja la hipòtesi nul·la i per tant podem dir que el preu de venda presenta variàncies estadísticament diferents segons el barri.

A continuació es compara d'una forma no paramètrica les distribucions dels barris que van ser categoritzats com grup 1 i grup 2 aplicant el test de Wilcox.

```{r echo=TRUE, message=FALSE, warning=FALSE}
  wilcox.test(SalePrice ~ vnNeighborhood, data = train, subset = vnNeighborhood <3)
```

Per tant es comprova d'una manera més formal, que es refusa la hipòtesi nul·la perquè p-vale <0.05 que els grups de barris 1 i 2 són estadísticament diferents en quan al preu de venda de les cases.

Cada barri està en un grup (segons la mitja de preus de venda. Grup 1 amb els barris que tenen les cases més barates, grup 3: barris amb les cases més cares) 

```{r echo=TRUE, message=FALSE, warning=FALSE}
unique ((train[c("vnNeighborhood","Neighborhood")]))

```

s'analitza visualment per OverallQual (ratis de qualitat en quant acabats de la casa) els barris relacionats.

```{r echo=TRUE, message=FALSE, warning=FALSE}
filas=dim(train)[1] #1460 rows
ggplot(data=train[1:filas,],aes(x=OverallQual,fill=Neighborhood))+geom_bar()

```

S'observa per exemple que la relació de qualitat de la casa en els valors de 9-10 està present en els barris del grup 3.


## Comparació de preus de cases per decada de construcció de la casa
Hi ha una diferència entre els preus de venda dels anys 80 als anys 90?

Creació dels subsets:

```{r echo=TRUE, message=FALSE, warning=FALSE}
train.SalePrice80s <-train$SalePrice[train$YearBuilt >1979 & train$YearBuilt <=1989]
train.SalePrice90s <-train$SalePrice[train$YearBuilt >1989 & train$YearBuilt <=2000] 

```

Es comprova la normalitat, donat que serien subsets de la variable SalePrice. S'usa el mètode de Kolmogorov-Smirnov 

```{r echo=TRUE, message=FALSE, warning=FALSE}
ks.test(train.SalePrice80s, pnorm, mean(train.SalePrice80s), sd(train.SalePrice80s)) 

```

Assumint com a hipòtesi nul·la que la població està distribuïda normalment, Al ser el p-valor més gran que el nivell de significació,(per defecte α=0,05) la hipòtesi nul·la no es podria rebutjar i amb un 95% de confiança podríem dir que la distribució és normal.

Ara bé, passant el test de shapiro, la hipòtesi nul·la sí s'hauria de rebutjar:
```{r echo=TRUE, message=FALSE, warning=FALSE}
shapiro.test(train.SalePrice80s)
```

Es comprova si en la decada dels 90 els preus segueixen una distribució normal

```{r echo=TRUE, message=FALSE, warning=FALSE}
ks.test(train.SalePrice90s, pnorm, mean(train.SalePrice90s), sd(train.SalePrice90s)) 

```

Segons Kolmogorov-Smirnov, la distribució dels 90 no seria normal. Es comprova com tampoc ho és seguint Shapiro-Wilk.
```{r echo=TRUE, message=FALSE, warning=FALSE}
shapiro.test(train.SalePrice90s)
```

Es fa el test d'homoscedasticitat per a comprovar si les variances  són iguals. 

Es comprova l'anàlisi de variances amb el test no paramètric de Fligner. Com que el nombre d'elements en cada sample és diferent es fa un stack previ en un nou dataframe anomenat stacked:

```{r echo=TRUE, message=FALSE, warning=FALSE}
stacked <- stack(list(train.SalePrice80s=train.SalePrice80s,train.SalePrice90s=train.SalePrice90s))
 fligner.test(values ~ ind, data = stacked)

```

Segons el test de Fligner-Killeen les variances seguirien una distribució similar entre SalesPrice 80 i 90.

Es comparen els preus dels 80s amb els 90s seguint el test no paramètric de Wilcoxon i Mann-Whitney. La hipòtesi nul·la seria la igualtat de les distribucions :

```{r echo=TRUE, message=FALSE, warning=FALSE}
stacked <- stack(list(train.SalePrice80s=train.SalePrice80s,train.SalePrice90s=train.SalePrice90s))
wilcox.test(values ~ ind, data = stacked)
#wilcox.test(values ~ ind, data = stacked, subset = Month %in% c(5, 8)) 
```

Donat que el test dona un p-value < 0.05, s'hauria de rebutjar la hipòtesi nul·la i per tant concloure que els preus són estadísticament diferents entre els 80 i els 90s

Donat que alguns tests són positius i altres negatius, es fa una representació visual també. Es pot concloure que la mitja del preu de venda, tot i diferent, no pujaria excessivament dels 80s als 90s. Possiblement un dels factors que està impactant en la comparació paramètrica dels preus, serien alguns preus molt alts (Outliers) trobats en la dècada dels 90.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Plot
summary(train.SalePrice80s)
summary(train.SalePrice90s)
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Plot
p <- ggplot(train, aes(x=YearBuilt, y=SalePrice/1000)) + geom_line()
ggplotly(p)
```

## Anàlisi de l'evolució del preu de venda al llarg dels anys
En el nostre dataset tenim 4 variables de temps que ens poden servir per obtenir un anàlisi interessant sobre l'evolució dels preus de les vivendes al llarg del temps. Aquests 4 atributs són:

1. YearBuilt
2. YearRemodAdd
3. GarageYrBlt
4. YrSold

A continuació estudiarem el preu de venda en funció d'aquestes variables de temps.

```{r echo=TRUE, message=FALSE, warning=FALSE}
#Tornem a llegir el dataset i agafem només les columnes que necessitem per aquest anàlisi
trainTime <- read_csv('HousePrices/train.csv' )
trainTime = subset(trainTime, select = c(YearBuilt, YearRemodAdd, GarageYrBlt, YrSold, SalePrice) )
```

Primer de tot observem l'evolució del preu en funció de YearBuilt, és a dir, l'any de construcció de la vivenda.
```{r echo=TRUE, message=FALSE, warning=FALSE}
#Calculem la mitja del SalePrice en funció de YearBuilt
priceYearBuilt <- summarize(group_by(trainTime, YearBuilt), SalePriceMean = mean(SalePrice, na.rm=T), n=n())

#Mostrem el gràfic fent servir el paquet plotly que ens permet interactuar amb les dades mostrades
p <- ggplot(priceYearBuilt, aes(x=YearBuilt, y=SalePriceMean)) + geom_line() + xlab("")
ggplotly(p)
```

Veiem que en determinats anys el valor mitjà varia molt respecte als anys anteriors i posteriors. Això és degut a que en alguns casos tenim molt poques observacions per alguns anys concrets. Per a que la gràfica representi de forma més acurada l'evolució dels preus filtrem per a mostrar únicament els preus mitjans calculats tenint més de 5 observacions per aquell any.

```{r echo=TRUE, message=FALSE, warning=FALSE}
priceYearBuilt5 <- filter(priceYearBuilt, n>5)
p5 <- ggplot(priceYearBuilt5, aes(x=YearBuilt, y=SalePriceMean)) + geom_line() + xlab("")
ggplotly(p5)
```

Veiem que excloent els anys amb poques observacions, en general, com més noves són les construccions més valor tenen les vivendes. Aquest fet té sentit, tot i que apreciem també que el preu no té una relació massa directa amb això, sinó que més aviat té a veure amb altres factors a nivell econòmic. Arribem a aquesta conclusió observant com a l'any 2009 hi ha una baixada molt pronunciada del preu de les vivendes respecte de l'any anterior, tot i ser més noves. Aquest fet és degut a l'efecte de la crisi econòmica que es va iniciar a partir del 2008 i que va afectar al preu de venda de les vivendes de nova construcció els anys següents.

Si observem el primer gràfic amb totes les dades, veiem que s'han venut algunes vivendes antigues (en concret una vivenda l'any 1893 i dues l'any 1892) amb un preu molt elevat. Analitzant amb detall aquestes observacions veiem que es tracta en tots els casos de vivendes que han estat remodelades posteriorment i de gran tamany i qualitat.

Ara observarem l'evolució dels preus per la variable YearRemodAdd.
```{r echo=TRUE, message=FALSE, warning=FALSE}
#Calculem la mitja del SalePrice en funció de YearRemodAdd
priceYearRemodAdd <- summarize(group_by(trainTime, YearRemodAdd), SalePriceMean = mean(SalePrice, na.rm=T), n=n())

#Mostrem el gràfic
p <- ggplot(priceYearRemodAdd, aes(x=YearRemodAdd, y=SalePriceMean)) + geom_line() + xlab("")
ggplotly(p)
```

En aquest cas, totes les observacions són posteriors a l'any 1950 i no hi ha cap any amb menys de 4 observacions, amb la qual cosa no cal filtrar els anys amb poques observacions. 

Pel que fa al gràfic observem com el preu de venda és clarament més elevat com més recent és la remodelació de la vivenda. Aquest increment del preu és especialment pronunciat si la reforma s'ha efectuat dintre dels 3 últims anys (en el cas de la mostra del 2007 al 2010).

Comprovem ara GarageYrBlt
```{r echo=TRUE, message=FALSE, warning=FALSE}
#Calculem la mitja del SalePrice en funció de GarageYrBlt
priceGarageYrBlt <- summarize(group_by(trainTime, GarageYrBlt), SalePriceMean = mean(SalePrice, na.rm=T), n=n())

#Mostrem el gràfic
p <- ggplot(priceGarageYrBlt, aes(x=GarageYrBlt, y=SalePriceMean)) + geom_line() + xlab("")
ggplotly(p)
```

En aquest cas veiem que els resultats s'assemblen bastant als obtinguts per la variable YearBuilt. Aquesta sebmlança té sentit, ja que en la majoria dels casos, s'acostuma a construir el garatge al mateix temps que la resta de la casa.

Finalment, mirem la variable YrSold.
```{r echo=TRUE, message=FALSE, warning=FALSE}
#Calculem la mitja del SalePrice en funció de YrSold
priceYrSold <- summarize(group_by(trainTime, YrSold), SalePriceMean = mean(SalePrice, na.rm=T), n=n())

#Mostrem el gràfic
p <- ggplot(priceYrSold, aes(x=YrSold, y=SalePriceMean)) + geom_line() + xlab("")
ggplotly(p)
```

En aquest cas, les observacions que tenim mostren el preu de venda mig de les vivendes venudes entre els anys 2006 i 2010. Aquesta franja de temps és interessant, ja que com podem veure a la gràfica, es veu clarament la incidència de la crisi econòmica del 2008 en la baixada importantíssima dels preus de venda a partir d'aquell any.


******
# Model: Regressió Lineal
******
Es fa una aproximació de la relació de dependència lineal entre la variable a predir: Sale Price i un subset de variables abans identificades com més correlacionades amb SalesPrice.


```{r echo=TRUE, message=FALSE, warning=FALSE}
lmSalePrice1  = lm(SalePrice~OverallQual+YearBuilt+vnNeighborhood+vnKitchenQual
                  +FullBath+GarageCars+GarageArea+GrLivArea,data=train) 
#summary(lmSalePrice)
```

Veiem com usant les variables originals el R-Squared millora, sent de 8.1.

```{r echo=TRUE, message=FALSE, warning=FALSE}
lmSalePrice2  = lm(SalePrice~OverallQual+YearBuilt+Neighborhood+KitchenQual
                  +FullBath+GarageCars+GarageArea+GrLivArea,data=train) 
#summary(lmSalePrice)
```

Amb altres variacions provades el R-Square seria menor.

```{r echo=TRUE, message=FALSE, warning=FALSE}
lmSalePrice3  = lm(SalePrice~FullBath+YearBuilt+vnNeighborhood+vnKitchenQual
                  +OverallQual+GarageFinish+GrLivArea,data=train) 
#summary(lmSalePrice)$r.squared
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
lmSalePrice4  = lm(SalePrice~FullBath+YearBuilt+Neighborhood+KitchenQual
                  +OverallQual+GarageFinish+GrLivArea+ExterQual+BsmtQual+TotalBsmtSF,data=train) 

```

Es comprova que no hi ha un guany signiifcatiu afegint moltes variables predictores.

```{r echo=TRUE, message=FALSE, warning=FALSE}
lmSalePrice5  = lm(SalePrice~MSSubClass+MSZoning+Neighborhood+KitchenQual
                  +OverallQual+GarageFinish+GrLivArea+ExterQual+BsmtQual+TotalBsmtSF+
                    LotArea+LotShape+LandContour+BldgType+HouseStyle+
                    YearRemodAdd+Exterior1st+ExterQual+Foundation+HalfBath+
                    BedroomAbvGr+Fireplaces+FireplaceQu+
                    GarageCars+GarageArea+GarageQual+PavedDrive+WoodDeckSF+OpenPorchSF
                   ,data=train)




```


```{r echo=TRUE, message=FALSE, warning=FALSE}

print (paste("Model 1 -->", summary(lmSalePrice1)$r.squared))
print (paste("Model 2 -->", summary(lmSalePrice2)$r.squared))
print (paste("Model 3 -->", summary(lmSalePrice3)$r.squared))
print (paste("Model 4 -->", summary(lmSalePrice4)$r.squared))
print (paste("Model 5 -->", summary(lmSalePrice4)$r.squared))
# no hi ha guany significatiu afegint més variables print (paste("Model 5 -->", summary(lmSalePrice5)$r.squared))

```

El model amb un major coeficient de determinació és el model 5, però no s'obté una guany significatiu respecte el model 4 afegint un gran nombre de variables predictores. Per tant el model triat és el model 4, capaç d'explicar la variabilitat de les dades en un 81,9% (Adjusted R-Squared).


```{r echo=TRUE, message=FALSE, warning=FALSE}
summary(lmSalePrice4)
#table(train$Street)
```


Predicció de preus de cases
```{r echo=TRUE, message=FALSE, warning=FALSE}

#newHousePrice <- data.frame()

newHouse <- data.frame( FullBath = 2, YearBuilt = 2003, Neighborhood = "CollgCr",
                       KitchenQual = "Gd", OverallQual = 7, GarageFinish="RFn",
                       GrLivArea=1710, ExterQual ="Gd",BsmtQual="Gd", TotalBsmtSF=856)
predict(lmSalePrice4, newHouse)

```

Aquesta new house passada al model existeix en el sistema amb el valor:208500

```{r echo=TRUE, message=FALSE, warning=FALSE}

head(subset(train, select = c(FullBath,YearBuilt,Neighborhood,KitchenQual
                          ,OverallQual,GarageFinish,GrLivArea,ExterQual,BsmtQual,TotalBsmtSF,SalePrice) ),1)
```

Predicció del dataset de test usant el model de regressió lineal. Per Id es prediu el preu de venda. Això és també el repte demanat a Kaggle.

```{r echo=TRUE, message=FALSE, warning=FALSE}
predictHousePrice<- predict(lmSalePrice4, test)
#output <- cbind(testdata, prediction)
output <- cbind(test, predictHousePrice)
#output
```

S'exporta a un fitxer CSV el Id del data source de test i el preu de venda predit pel model. Aquest fitxer és el demanat al challenge de Kaggle.
```{r echo=TRUE, message=FALSE, warning=FALSE}
kaggleChallenge = subset(output, select = c(Id,predictHousePrice ) )

write.csv(kaggleChallenge,".\\PRA2DamEus_Submission.csv", row.names = FALSE)
```

De les 1459 observacions del datasource de test, s'observa que 116 de les prediccions han estat na i per tant el model no ha estat capaç de predir.

```{r echo=TRUE, message=FALSE, warning=FALSE}
sapply(output, function(x) sum(is.na(x)))
```

En la Distància de cook del model, s'observa un punt molt allunyat i altres amb una certa distància.

```{r echo=TRUE, message=FALSE, warning=FALSE}
plot(cooks.distance(lmSalePrice4), pch = 16, col = "blue")

```


******
# Conclusions
******
Tras analitzar les característiques d'aquest data set sobre les cases de Iowa, s'observa que els valors NA són propis del domini, o almenys així es registra en la definició del data set. S'aprecien valors outliers que impacten la potència estadística, però es decideix no treurel's donat que semblen valors correctes analitzat el contexte d'altres variables que indiquen que el preu podria estar justificat, per la qualitat dels materials, any de construcció, metres del garatge o altres característiques que fan pensar que el valor és correcte. En aquest sentit hem tingut un dilema en quant a l'eliminació o tractament dels outliers per a obtenir una major potència estadística vs mantenir els valors al comprovar que tot indica que són correctes. Finalment s'ha decidit la segona opció.

Es fa una reducció de la dimensionalitat: eliminant aquells atributs que tenen el valor NA en la majoria dels seus registres i aquells atributs on no s'observa cap correlació amb la variable SalePrice. Per a analitzar la correlació dels atributs categòrics es creen variables numèriques ordinals a partir de les variables qualitatives. En els casos on no es pot establir un ordre es fa una mitja del preu per cadascú de les categories de la variable i s'estableix així l'ordre. Donat que hi ha una manca de normalitat en les variables, s'aplica el test de correlació no paramètric de Spearman.

Els atributs amb una més alta correlació són els incorporats al model de regressió lineal múltiple, que és el que s'usa per predir el preu en el challenge de Kaggle. El model obtingut té un coeficient de determinació d'un 82%. S'observa que en 16 casos dels 1451 observacions del dataset de test no és capaç de predir i el valor és NA. En general amb les proves fetes s'ha observat que el preu del model s'aproxima bastant al preu real.

En quant a la comparació de grups, tant en la comparació del preu per barris com comparant els preus dels anys 80 i 90, s'observen diferencies estadístiques en el preu de venda, més clares en la comparació per barris i no tan evidents en la comparació de preus entre els 80 i els 90 on hi ha un lleuger augment de la mitjana dels preus i una forta presència de preus molt elevats en els anys 90 (outliers).

Finalment, pel que fa a l'evolució dels preus al llarg del temps, amb l'anàlisi realitzat sobre les variables temporals del dataset hem pogut observar resultats interessants com, per exemple, el fet de que les cases reformades en els últims 2-3 anys experimenten un augment molt significatiu del seu preu de venda. O també, que amb la crisi econòmica del 2008 els preus de venda van baixar dràsticament per a tots els casos.


******
# Taula de contribucions
******
```{r echo=FALSE, message=FALSE, warning=FALSE}
contributions_table <- data.frame("Contribucions" = c("Investigació prèvia", "Redacció de les respostes", "Desenvolupament codi"), "Firma" = "Eusebio Garcia i Damián Martínez")
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
kable(contributions_table)
```


******
# WEBGRAPHY
******
HousePrices - kaggle
https://www.kaggle.com/c/house-prices-advanced-regression-techniques/overview

HousePrices - kaggle - Tutorials
https://www.kaggle.com/c/house-prices-advanced-regression-techniques/overview/tutorials

HousePrices - Kaggle - Start Here - Visualization and Model Stacking
https://www.kaggle.com/rp1611/start-here-visualization-and-model-stacking

Trabajo de Fin de Grado - ESTUDIO DE TÉCNICAS SUPERVISADAS DE REDUCCIÓN
DE DIMENSIONALIDAD PARA PROBLEMAS DE CLASIFICACIÓN - Álvaro Soriano Maganto  2016-2017
https://e-archivo.uc3m.es/bitstream/handle/10016/26504/TFG_Alvaro_Soriano_Maganto.pdf

The most common dimension techniques - RPubs
https://rpubs.com/Saskia/520216

Análisis de Regresión - Alfonso Novales - Departamente de Economía Cuantitativa 2010
https://www.ucm.es/data/cont/docs/518-2013-11-13-Analisis%20de%20Regresion.pdf

StackOverflow - R - Perform a levene test with two samples with different sizes
https://stackoverflow.com/questions/43749166/r-perform-a-levene-test-with-two-samples-with-different-sizes